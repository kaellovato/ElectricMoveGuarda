# Workflow para atualizar automaticamente o cat√°logo de ve√≠culos
# Executa semanalmente (segundas √†s 6h da manh√£ UTC, que √© 6h ou 7h em Portugal)

name: üöó Atualizar Cat√°logo de Ve√≠culos

on:
  # Execu√ß√£o autom√°tica semanal
  schedule:
    - cron: "0 6 * * 1" # Segundas-feiras √†s 06:00 UTC

  # Permite execu√ß√£o manual
  workflow_dispatch:
    inputs:
      force_update:
        description: "For√ßar atualiza√ß√£o mesmo sem mudan√ßas"
        required: false
        default: false
        type: boolean

jobs:
  update-catalog:
    name: üìã Atualizar Cat√°logo
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout do reposit√≥rio
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: üîß Instalar depend√™ncias
        run: npm ci

      - name: üåê Instalar Chromium para Puppeteer
        run: npx puppeteer browsers install chrome

      - name: üîç Executar scraper
        id: scraper
        run: |
          echo "Iniciando scraping..."
          node scraper.js

          # Verificar se o arquivo foi atualizado
          if [ -f vehicles.json ]; then
            echo "‚úÖ Arquivo vehicles.json atualizado"
            echo "vehicles_updated=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Falha ao gerar vehicles.json"
            echo "vehicles_updated=false" >> $GITHUB_OUTPUT
            exit 1
          fi
        env:
          PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: false

      - name: üìä Mostrar estat√≠sticas
        run: |
          echo "üìä Estat√≠sticas do cat√°logo:"
          cat vehicles.json | head -20
          echo ""
          echo "Total de ve√≠culos: $(cat vehicles.json | grep -o '"fullTitle"' | wc -l)"

      - name: üîÑ Verificar altera√ß√µes
        id: git_status
        run: |
          git diff --quiet vehicles.json && echo "changed=false" >> $GITHUB_OUTPUT || echo "changed=true" >> $GITHUB_OUTPUT

      - name: üì§ Commit e Push das altera√ß√µes
        if: steps.git_status.outputs.changed == 'true' || github.event.inputs.force_update == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions Bot"

          # Data formatada para o commit
          DATE=$(TZ='Europe/Lisbon' date '+%d/%m/%Y √†s %H:%M')

          git add vehicles.json
          git commit -m "üöó Cat√°logo atualizado automaticamente - $DATE"
          git push

          echo "‚úÖ Altera√ß√µes enviadas para o reposit√≥rio"

      - name: ‚ÑπÔ∏è Sem altera√ß√µes
        if: steps.git_status.outputs.changed == 'false' && github.event.inputs.force_update != 'true'
        run: |
          echo "‚ÑπÔ∏è Nenhuma altera√ß√£o detectada no cat√°logo"
          echo "O cat√°logo j√° est√° atualizado"

  # Job opcional para notifica√ß√£o (descomente se quiser usar)
  # notify:
  #   name: üìß Notificar
  #   needs: update-catalog
  #   runs-on: ubuntu-latest
  #   if: failure()
  #   steps:
  #     - name: Enviar notifica√ß√£o de erro
  #       run: |
  #         echo "Erro na atualiza√ß√£o do cat√°logo"
  #         # Adicione aqui integra√ß√£o com email, Slack, Discord, etc.
